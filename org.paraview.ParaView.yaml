app-id: org.paraview.ParaView
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
base: io.qt.qtwebengine.BaseApp
base-version: '5.15'
rename-icon: paraview
command: paraview
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=home
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - /etc
  - '*.la'
  - '*.a'

# Disable ARM support, ParaView does not support it anyway.
modules:
  - shared-modules/glew/glew.json

  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3a/be/650f9c091ef71cb01d735775d554e068752d3ff63d7943b26316dc401749/numpy-1.21.2.zip
        sha256: 423216d8afc5923b15df86037c6053bf030d15cc9e3224206ef868c2d63dd6dc
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-certifi
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/6d/78/f8db8d57f520a54f0b8a438319c342c61c22759d8f9a1cd2e2180b5e5ea9/certifi-2021.5.30.tar.gz
        sha256: 2bbf76fd432960138b3ef6dda3dde0544f27cbf8546c458e60baf371917ba9ee
        x-checker-data:
          type: pypi
          name: certifi

  - name: qhull
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e

  - name: python-matplotlib
    buildsystem: simple
    build-options:
      env:
        MPLSETUPCFG: /run/build/python-matplotlib/matplotlib-setup.cfg
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: file
        path: matplotlib-setup.cfg
      - type: archive
        url: https://files.pythonhosted.org/packages/21/37/197e68df384ff694f78d687a49ad39f96c67b8d75718bc61503e1676b617/matplotlib-3.4.3.tar.gz
        sha256: fc4f526dfdb31c9bd6b8ca06bf9fab663ca12f3ec9cdf4496fb44bc680140318
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: python-pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c1/47/dfc9c342c9842bbe0036c7f763d2d6686bcf5eb1808ba3e170afdb282210/pyparsing-2.4.7.tar.gz
        sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1
        x-checker-data:
          type: pypi
          name: pyparsing

  - name: python-cycler
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c2/4b/137dea450d6e1e3d474e1d873cd1d4f7d3beed7e0dc973b06e8e10d32488/cycler-0.10.0.tar.gz
        sha256: cd7b2d1018258d7247a71425e9f26463dfb444d411c39569972f4ce586b0c9d8
        x-checker-data:
          type: pypi
          name: cycler

  - name: python-cppy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/36/64/be592e84c443a70ea5dcfb1c30bfe6f10ba7d8eb05c2264c7ceca8498548/cppy-1.1.0.tar.gz
        sha256: 4eda6f1952054a270f32dc11df7c5e24b259a09fddf7bfaa5f33df9fb4a29642
        x-checker-data:
          type: pypi
          name: cppy

  - name: python-kiwisolver
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/8e/87/259fde8cf07d06677f0a749cb157d079ebd00d40fe52faaab1a882a66159/kiwisolver-1.3.2.tar.gz
        sha256: fc4453705b81d03568d5b808ad8f09c77c47534f6ac2e72e733f9ca4714aa75c
        x-checker-data:
          type: pypi
          name: kiwisolver

  - name: python-setuptools_scm
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4b/0d/ecb9595fae02467edba5023eb8a23c688d2b438a6a8d1a9e2b8649faf23d/setuptools_scm-6.3.2.tar.gz
        sha256: a49aa8081eeb3514eb9728fa5040f2eaa962d6c6f4ec9c32f6c1fba88f88a0f2
        x-checker-data:
          type: pypi
          name: setuptools_scm

  - name: python-dateutil
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4c/c4/13b4776ea2d76c115c1d1b84579f3764ee6d57204f6be27119f13a61d0a9/python-dateutil-2.8.2.tar.gz
        sha256: 0123cacc1627ae19ddf3c27a5de5bd67ee4586fbdd6440d9748f8abb483d3e86
        x-checker-data:
          type: pypi
          name: python-dateutil

  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 install --build-type=complete link=shared --layout=versioned runtime-link=shared
        cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
        sha256: f0397ba6e982c4450f27bf32a2a83292aba035b827a5623a14636ea583318c41

  #- name: hdf5
    #buildsystem: cmake-ninja
    #builddir: true
    #config-opts:
      #- -DCMAKE_BUILD_TYPE=RelWithDebInfo
      #- -DBUILD_TESTING:BOOL=OFF
      #- -DHDF5_BUILD_EXAMPLES:BOOL=OFF
      #- -DHDF5_ENABLE_Z_LIB_SUPPORT:BOOL=ON
    #sources:
      #- type: archive
        #url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.10/hdf5-1.10.5/src/hdf5-1.10.5.tar.bz2
        #sha256: 68d6ea8843d2a106ec6a7828564c1689c7a85714a35d8efafa2fee20ca366f44

  #- name: netcdf
    #sources:
      #- type: archive
        #url: https://github.com/Unidata/netcdf-c/archive/v4.7.4.tar.gz
        #sha256: 99930ad7b3c4c1a8e8831fb061cb02b2170fc8e5ccaeda733bd99c3b9d31666b

  - name: openmpi
    sources:
      - type: archive
        url: https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.1.tar.bz2
        sha256: e24f7a778bd11a71ad0c14587a7f5b00e68a71aa5623e2157bafee3d44c07cda

    # OSPRay 2.1.0 does not support newer TBB yet.
  - name: TBB
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/2019_U8.tar.gz
        sha256: 6b540118cbc79f9cbc06a35033c18156c21b84ab7b6cf56d773b168ad2b68566
      - type: patch
        path: tbb_cmake.patch

  - name: Embree
    buildsystem: cmake-ninja
    config-opts:
      - -DEMBREE_TUTORIALS:BOOL=OFF
      - -DEMBREE_ISPC_SUPPORT:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/embree/embree/archive/refs/tags/v3.13.0.tar.gz
        sha256: 4d86a69508a7e2eb8710d571096ad024b5174834b84454a8020d3a910af46f4f
    modules:
      - name: extra-cmake-modules
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://invent.kde.org/frameworks/extra-cmake-modules.git
            tag: v5.9.0
        # Attempt to build from source, but ISPC need glic-32bit which make things complicated.
        # OSPRay need ISPC 1.9.2.
      - name: ISPC
        buildsystem: simple
        build-commands:
          - cp bin/ispc /app/bin/
        sources:
          - type: archive
            url: https://github.com/ispc/ispc/releases/download/v1.15.0/ispc-v1.15.0-linux.tar.gz
            sha256: b67f50ab16b38d29e28b0a2dbb9733fd6fc1276cb5a5be0cac78e356941f881f
      - name: glfw
        buildsystem: cmake-ninja
        config-opts:
          - -DGLFW_USE_WAYLAND:BOOL=ON
          - -DBUILD_SHARED_LIBS:BOOL=ON
          - -DGLFW_BUILD_EXAMPLES:BOOL=OFF
          - -DGLFW_BUILD_TESTS:BOOL=OFF
          - -DGLFW_BUILD_DOCS:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/glfw/glfw/releases/download/3.3.4/glfw-3.3.4.zip
            sha256: bbd2c42c660b725e9755eb417e40b373f0d4c03138c9b2e210d02cd308bd99cd

    # For ray tracing
    # VTK need OSPRay 2.1.0
    # https://gitlab.kitware.com/vtk/vtk/-/blob/1e32bd23a169cfb2fcdf46796729db1530b1d899/Rendering/RayTracing/CMakeLists.txt#L59
  - name: OSPRay
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: https://github.com/ospray/ospray/archive/refs/tags/v2.1.0.tar.gz
        sha256: ab38106beac3868cb39ef35f5564d51277641ecd982afc45e463aada6a124502
    modules:
        # Deprecated for rkcommon, but OSPRay 2.1.0 need this
      - name: ospcommon
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/ospray/ospcommon/archive/refs/tags/v1.3.1.tar.gz
            sha256: 1c043c4a09e68fb7319db61f28a5830fc09f1457b24155a42b5f7c6421bcca73
      - name: rkcommon
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/ospray/rkcommon/archive/refs/tags/v1.6.0.tar.gz
            sha256: 24d0c9c58a4d2f22075850df170ec5732cfaa0a16f22f90dbd6538232be009b0
        # OSPRay does not build with openvkl newer than 0.9.0
      - name: openvkl
        buildsystem: cmake
        builddir: true
        config-opts:
          - -DBUILD_EXAMPLES:BOOL=OFF
          - -DBUILD_BENCHMARKS:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/openvkl/openvkl/archive/refs/tags/v0.9.0.tar.gz
            sha256: 06aa82c8c3ff68ab93fb8240f4881a1bc238b3de681812e71145f8a1629d3fee

  - name: GDAL
    sources:
      - type: archive
        url: https://download.osgeo.org/gdal/3.3.0/gdal-3.3.0.tar.gz
        sha256: 39fce17f8f421f4f81e3358b9cac21921355a344e20917ac6bd27d483f27e5c9
    modules:
      - name: PROJ
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/OSGeo/PROJ/releases/download/8.0.1/proj-8.0.1.tar.gz
            sha256: e0463a8068898785ca75dd49a261d3d28b07d0a88f3b657e8e0089e16a0375fa

  - name: GeoTIFF
    builddir: true
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app
      - make install -j
    sources:
      - type: archive
        url: https://download.osgeo.org/geotiff/libgeotiff/libgeotiff-1.6.0.tar.gz
        sha256: 9311017e5284cffb86f2c7b7a9df1fb5ebcdc61c30468fb2e6bca36e4272ebca

  - name: PDAL
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DWITH_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/PDAL/PDAL/releases/download/2.3.0/PDAL-2.3.0-src.tar.bz2
        sha256: 63d8d4fee491675f0fa3dca58c26d57fb2afcaa37c24b10f595b3fbff174996e

    ##https://github.com/boostorg/endian/issues/45
  #- name: libLAS
    #buildsystem: cmake-ninja
    #config-opts:
      #- -DWITH_TESTS=OFF
    #sources:
      #- type: archive
        #url: http://download.osgeo.org/liblas/libLAS-1.8.1.tar.bz2
        #sha256: 9adb4a98c63b461ed2bc82e214ae522cbd809cff578f28511122efe6c7ea4e76

  - name: ADIOS2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DWITH_TESTS:BOOL=OFF
      - -DADIOS2_RUN_INSTALL_TEST:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/ornladios/ADIOS2/archive/refs/tags/v2.7.1.436.tar.gz
        sha256: c8c0c3383b5f1e0afa77bfc67970050c0ef95132a94aa9b17419f60032fb7a31
        x-checker-data:
          type: anitya
          project-id: 220828
          stable-only: true
          url-template: https://github.com/ornladios/ADIOS2/archive/refs/tags/v$version.tar.gz

  - name: lapack
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.10.0.tar.gz
        sha256: 328c1bea493a32cac5257d84157dc686cc3ab0b004e2bea22044e0a59f6f8a19
        x-checker-data:
          type: anitya
          project-id: 1534
          stable-only: true
          url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  #- name: SWIG
    #sources:
      #- type: archive
        #url: https://sourceforge.net/projects/swig/files/swig/swig-4.0.2/swig-4.0.2.tar.gz
        #sha256: d53be9730d8d58a16bf0cbd1f8ac0c0c3e1090573168bfa151b01eb47fa906fc

  - name: OpenTURNS
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/openturns/openturns/archive/refs/tags/v1.17.tar.gz
        sha256: 42f65701f7cbd0081362be56c8232ddadfc21f2a32f636fd460919cd8f10c84d
        x-checker-data:
          type: anitya
          project-id: 220847
          stable-only: true
          url-template: https://github.com/openturns/openturns/archive/refs/tags/v$version.tar.gz

    # Provide libnuma for MEMKIND
  - name: numactl
    sources:
      - type: archive
        url: https://github.com/numactl/numactl/releases/download/v2.0.14/numactl-2.0.14.tar.gz
        sha256: 826bd148c1b6231e1284e42a4db510207747484b112aee25ed6b1078756bcff6
        x-checker-data:
          type: anitya
          project-id: 2507
          stable-only: true
          url-template: https://github.com/numactl/numactl/releases/download/v$version/numactl-$version.tar.gz

  - name: MEMKIND
    sources:
      - type: archive
        url: https://github.com/memkind/memkind/archive/refs/tags/v1.12.0.tar.gz
        sha256: b0781d493dec0da0089884fd54bcfdde03311019c56f90505ed0b884100bfbad
        x-checker-data:
          type: anitya
          project-id: 220852
          stable-only: true
          url-template: https://github.com/memkind/memkind/archive/refs/tags/v$version.tar.gz

    # Have permission to distribute this.
    # https://discourse.paraview.org/t/holoplaycore-is-propreitary-software/7295
  - name: HoloPlayCore
    buildsystem: simple
    build-commands:
      - cp -r HoloPlayCore/include/* /app/include
      - cp -r HoloPlayCore/dylib/linux/* /app/lib
    sources:
      - type: archive
        url: https://www.paraview.org/files/dependencies/HoloPlayCore-0.1.1-Open-20200923.tar.gz
        sha256: 8626082ddc89dbbd018e6113e069eb64c9f8e540db06c4c7e85162dc38b5ddad

    # Paraview need 32GB of memory to build
  - name: Paraview
    buildsystem: cmake
    builddir: true
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DBUILD_TESTING:BOOL=OFF
      - -DPARAVIEW_USE_QT:BOOL=ON
      - -DPARAVIEW_USE_QTHELP:BOOL=ON
      - -DPARAVIEW_USE_QTWEBENGINE:BOOL=ON
      - -DPARAVIEW_USE_PYTHON:BOOL=ON
      - -DPARAVIEW_ENABLE_WEB:BOOL=ON
      - -DPARAVIEW_ENABLE_EMBEDDED_DOCUMENTATION:BOOL=ON
      - -DVTK_PYTHON_OPTIONAL_LINK:BOOL=OFF
      - -DVTK_OPENGL_HAS_OSMESA:BOOL=OFF
      - -DBUILD_EXAMPLES:BOOL=ON
      - -DPARAVIEW_PLUGINS_DEFAULT:BOOL=ON
      - -DVTK_SMP_IMPLEMENTATION_TYPE:STRING=TBB
      - -DVTK_PYTHON_VERSION:STRING=3
      - -DVTK_PYTHON_FULL_THREADSAFE:BOOL=ON
      - -DVTK_NO_PYTHON_THREADS:BOOL=OFF
      - -DQtTesting_INSTALL_NO_DEVELOPMENT:BOOL=ON
      - -DVTK_BUILD_QT_DESIGNER_PLUGIN:BOOL=OFF
      - -DPARAVIEW_INSTALL_DEVELOPMENT_FILES:BOOL=ON
      - -DPARAVIEW_BUILD_WITH_EXTERNAL:BOOL=OFF
      - -DPARAVIEW_ENABLE_FFMPEG:BOOL=ON
      - -DPARAVIEW_ENABLE_VISITBRIDGE:BOOL=ON
      - -DPARAVIEW_ENABLE_RAYTRACING:BOOL=ON
      - -DPARAVIEW_USE_MPI:BOOL=ON
      #- -DPARAVIEW_USE_CUDA:BOOL=ON
      - -DHDF5_ENABLE_OPTIMIZATION:BOOL=ON
      - -DPARAVIEW_ENABLE_XDMF2:BOOL=ON
      - -DPARAVIEW_ENABLE_XDMF3:BOOL=ON
      - -DPARAVIEW_ENABLE_ADIOS2:BOOL=ON
      - -DPARAVIEW_ENABLE_FIDES:BOOL=ON
      - -DPARAVIEW_ENABLE_FFMPEG:BOOL=ON
      - -DPARAVIEW_ENABLE_GDAL:BOOL=ON
      #- -DPARAVIEW_ENABLE_LAS:BOOL=ON
      - -DPARAVIEW_ENABLE_OPENTURNS:BOOL=ON
      - -DPARAVIEW_ENABLE_PDAL:BOOL=ON
      - -DPARAVIEW_ENABLE_MOTIONFX:BOOL=ON
      - -DPARAVIEW_ENABLE_MOMENTINVARIANTS:BOOL=ON
      - -DPARAVIEW_ENABLE_LOOKINGGLASS:BOOL=OFF
      - -DHoloPlayCore_INCLUDE_DIR:PATH=/app/include
      - -DHoloPlayCore_LIBRARY:PATH=/app/lib
      - -DPARAVIEW_USE_MEMKIND:BOOL=ON
      - -DPARAVIEW_USE_VTKM:BOOL=ON
    sources:
      - type: archive
        url: https://www.paraview.org/files/v5.9/ParaView-v5.9.1.tar.gz
        sha256: efbcba00ba38c23d0ada1bde7144a8745caa308d9e1f94a4a71d8af63732266f
      - type: patch
        path: fix_appdata_file.patch
      - type: git
        url: https://github.com/Kitware/LookingGlassVTKModule
        commit: c1e0df4842f22929a50daa0fe580a6a3dd3f015a
        dest: VTK/Remote/RenderingLookingGlass
      - type: archive
        url: https://www.paraview.org/files/dependencies/HoloPlayCore-0.1.1-Open-20200923.tar.gz
        sha256: 8626082ddc89dbbd018e6113e069eb64c9f8e540db06c4c7e85162dc38b5ddad
      - type: git
        url: https://gitlab.kitware.com/vtk/MomentInvariants.git
        # See commit at VTK/Remote
        commit: 9f103291cd96c2757dbefa6a7a0bea1bb8cd9abf
        dest: VTK/Remote/MomentInvariants

    # Don't know why using post-install on ParaView fail.
  - name: install-icon
    buildsystem: simple
    build-commands:
      - install -Dm644 pvIcon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: file
        path: pvIcon.svg
